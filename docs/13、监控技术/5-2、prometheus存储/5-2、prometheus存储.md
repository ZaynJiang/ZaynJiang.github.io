## 1. 存储方式

Prometheus提供了两种存储方式：

* 本地存储
* 远程存储

### 1.1. 抽象接口

#### 2.1. 添加数据

#### 2.2. 查询数据

## 2. 本地存储

### 2.1. leveldb

### 2.2. tsdb

tsdb有两大核心概念:

* block

  包含chunk、index、meta.json、tombstones

* wal

#### 2.2.1. block

block的划分是根据时间维度进行的。按照步数递增划分，比如步数为3，2h、6h、18h。

唯一名称ulid，为16字节，前6字节为时间戳，后10字节为随机数。

一个blcok由4个组件组成

* chunk

  固定512m大小，多个按照序号编号

* index

  索引，记录数据在chunk中的偏移量

* meta.json

  记录了block元信息，起始时间，结束时间，数据源、样本数、chunk数、压缩次数

* tombstones

  用于删除行数据后的软删除记录.

第一个block存储在内存中，允许修改，其它的block只读的形式存储在硬盘之中。block初始设定为2h数据

#### 2.2.2. wal

预写日志，用于是实现事务的，操作前将数据记录下来，以便后面回滚。

这个类似与mysql的redo日志，Prometheus会将周期性采集的监控数据通过Add接口添加到head block中，但这些数据没有被持久化，TSDB通过WAL将提交的数据先保存到磁盘中，在TSDB宕机重启后，会首先启动协程读取WAL从而进行恢复.

#### 2.2.3. 保存时间

#### 2.2.4. 保存路径

## 3. 远程存储

### 3.1. 远程存储架构

### 3.2. 配置远程存储

### 3.3. 数据聚合

## 4. 小结