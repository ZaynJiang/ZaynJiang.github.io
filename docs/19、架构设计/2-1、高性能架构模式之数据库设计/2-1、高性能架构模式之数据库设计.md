## 1. 开头  
&emsp;&emsp;为了更快、更好地设计出优秀的架构，除了需要有基础的架构设计理论外，还需要掌握业界已经成熟的各种架构模式。  
&emsp;&emsp;各种存储技术飞速发展，但关系数据库由于其 ACID 的特性和功能强大的 SQL 查询，目前还是各种业务系统中关键和核心的存储系统，很多场景下高性能的设计最核心的部分就是关系数据库的设计。  
&emsp;&emsp;单个数据库服务器已经难以满足业务需要，必须考虑数据库集群的方式来提升性能。高性能数据库集群一般有两种模式可以考虑：  
* 读写分离
* 分库分表
  

## 2. 读写分离 
### 2.1. 原理   
&emsp;&emsp;读写分离的基本原理是将数据库读写操作分散到不同的节点上。  
![](读写分离架构.png)  
* 数据库服务器搭建主从集群，一主一从、一主多从都可以。
* 数据库主机负责读写操作，从机只负责读操作。
* 数据库主机通过复制将数据同步到从机，每台数据库服务器都存储了所有的业务数据。
* 业务服务器将写操作发给数据库主机，将读操作发给数据库从机   


**注意：主从和主备不一样，从是需要干活的，备一般被认为仅仅提供备份功能，不提供访问功能**    


### 2.2. 主从复制复杂度  
&emsp;&emsp;MySQL 为例，主从复制延迟可能达到 1 秒，大量数据同步，延迟 1 分钟也是有可能的，如果业务上有逻辑依赖读到的数据，那就会存在问题。    
解决方案：  
* 写操作后的读操作指定发给数据库主服务器  
  代码耦合度高，侵入严重。
* 读从机失败后再读一次主机  
  二次读取，如果有很多二次读取，将大大增加主机的读操作压力  
**PS：我们也可以先查redis，再查库表，如果redis中没有，说明就是过期的数据，这时候查从机就肯定存在了**
* 关键业务读写操作全部指向主机，非关键业务采用读写分离  
  关键业务走主库，不关键业务走从库，分离。


### 2.3. 分配机制复杂度    
即如何实现这个读写分离呢？  

#### 2.3.1. 程序代码封装  
在代码中抽象一个数据访问层（所以有的文章也称这种方式为“中间层封装”），实现读写操作分离和数据库服务器连接的管理  
常用的技术有，shardingjdbc、苞米豆  
![](读写分离代码架构.png)  
* 实现简单，而且可以根据业务做较多定制化的功能。
* 每个编程语言都需要自己实现一次，无法通用，如果一个业务包含多个编程语言写的多个子系统，则重复开发的工作量比较大。
* 故障情况下，如果主从发生切换，则可能需要所有系统都修改配置并重启。  



#### 2.3.2. 中间件封装  
独立一套系统,实现读写操作分离和数据库服务器连接的管理,对业务服务器提供 SQL 兼容的协议，业务服务器无须自己进行读写分离.对于业务服务器来说，访问中间件和访问数据库没有区别，事实上在业务服务器看来，中间件就是一个数据库服务器  
![](读写分离代理中间件架构.png)  
* 支持多种编程语言  
  因为数据库中间件对业务服务器提供的是标准 SQL 接口。
* 数据库中间件要支持完整的 SQL 语法和数据库服务器的协议（例如，MySQL 客户端和服务器的连接协议）
  实现比较复杂，细节特别多，很容易出现 bug，需要较长的时间才能稳定。

* 数据库中间件自己不执行真正的读写操作，但所有的数据库操作请求都要经过中间件，中间件的性能要求也很高。

* 数据库主从切换对业务服务器无感知，数据库中间件可以探测数据库服务器的主从状态。
  例如，向某个测试表写入一条数据，成功的就是主机，失败的就是从机。     

* 系统一旦做好，接入的业务系统越多，节省的程序开发投入就越多，价值也越大
* 数据库中间件的复杂度要比程序代码封装高出一个数量级  
  
  ![](mysqlserver架构.png)  

  ### 2.4. 小结  
