## 1. 消费分组基本概念
### 1.1. 消费模型 
&emsp;&emsp;传统的消息系统的引擎模型主要有两类：  
* 点对点
* 发布订阅模型   

&emsp;&emsp;它们各有优缺点，点对点一旦消息被消费就会被删除，而且只能被一个消费者实例消费，伸缩性很差。而发布订阅模型，允许多个消费者消费，但是伸缩性也不高，因为一个消费者实例需要订阅所有的分区信息，这种也是不灵活扩展性也不好。  
&emsp;&emsp;kafka的消费者分组，避开这两种模型的缺陷又兼具它们的优点，什么是消费者分组呢？  
&emsp;&emsp;一个消费者分组内可以有多个消费者或消费者实例，它们共享一个公共的groupid，组内的消费者实例协调起来一起消费者一个主题下的分区。如果所有实例都属于同一个 Group，那么它实现的就是消息队列模型；如果所有实例分别属于不同的 Group，那么它实现的就是发布订阅模型。  
&emsp;&emsp;消费者分组可以总结如下的特性：
* groupid唯一标识一个消费者分组
* Consumer分组下可以有一个或多个Consumer实例
* 一个主题的分区只能被唯一的一个消费者实例消费
### 1.2. kafka的消费分区  
&emsp;&emsp;如何确定消费者的实例个数呢，理想情况下，Consumer 实例的数量应该等于该 Group 订阅主题的分区总数，当消费者实例的个数大于分区数时，将会有分区不能分配到改消费者实例。它将属于空闲状态，浪费资源  
&emsp;&emsp;消费者在消费的过程中需要记录自己消费了多少数据，在kafka中有个Offset来管理消费位移，在java中就是个Map，如 Map<TopicPartition, Long>表示某个分区消费到了某个位移了。  
&emsp;&emsp;在早期的版本，消费者的位移信息会被提交到zk上，但是这种频繁更新的操作是不适合在zk上进行的。于是后来的版本重新设计了位移的管理方式，即将位移保存在 Kafka内部的特殊主题。
### 1.3. kafka的消费Rebalance 
#### 1.3.1. Rebalance时机和过程   
&emsp;&emsp;Rebalance 是一种机制，使得同一消费者分组下的实例比较合理的分配分区。什么时候进行Rebalance呢？
* 组成员数发生变更,比如下线实例或者新增消费者实例
* 订阅主题数发生变更，订阅的消费者主题发生了变化，比如消费者实例订阅某个主题，新增了一个主题
* 主题分区发生了变化，kafka对某个主题新增了分区（注意kafka是不允许减少分区的）  

&emsp;&emsp;Rebalance是如何进行rebalance的呢？它的基本原则就是尽可能保证每个消费者实例的分区数均匀。  
![](消费分组分区.png)  
如何所示，当新增了消费者后，6个分区重新分布了，由每个消费者三个分区变成每个消费者两个分区了。
#### 1.3.2. Rebalance的影响  
在 Rebalance 过程中，所有 Consumer 实例都会停止消费，导致Rebalance 实在是太慢了如果消费者有上百个的话，成功进行rebalance会很耗时。所以需要避免rebalance